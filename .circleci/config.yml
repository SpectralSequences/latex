version: 2.1

defaults: &defaults

jobs:
  test-examples:
    parameters:
      image:
        description: Which docker image should we use?
        type: string
    working_directory: ~/repo
    docker:
      - image: << parameters.image >>

    steps:
      - checkout
      - run:
          name: l3build install
          command: |
            if [ -z ${SAVED_PATH+x} ]; then :; else
              export PATH=$SAVED_PATH
            fi
            cd spectralsequences
            l3build install
      
      - run:
          name: test examples
          command: |
            cd spectralsequences
            ./compile_examples.sh

      - store_artifacts:
          path: /root/repo/examples_output


  build-manual:
    parameters:
      image:
        description: Which docker image should we use?
        type: string
    working_directory: ~/repo
    docker:
      - image: << parameters.image >>

    steps:
      - checkout
      - run:
          name: l3build install
          command: |
            if [ -z ${SAVED_PATH+x} ]; then :; else
              export PATH=$SAVED_PATH
            fi
            cd spectralsequences
            l3build install

      - run:
          name: build manual
          command: |
              cd spectralsequences/manual
              pdflatex spectralsequencesmanual.tex

      - store_artifacts:
          path: /root/repo/spectralsequences/manual/spectralsequencesmanual.pdf

  test-regrtest:
    parameters:
      image:
        description: Which docker image should we use?
        type: string
    working_directory: ~/repo
    docker:
      - image: << parameters.image >>
    
    steps:
      - checkout
      - run:
          name: l3build check
          command: |
            cd spectralsequences
            if [ -z ${SAVED_PATH+x} ]; then :; else
              export PATH=$SAVED_PATH
            fi
            export diffexe="git diff --no-index --color"
            l3build check -e pdftex test parsers range-check styles \
              || (cat build/test/*.diff && false)
      - store_artifacts:
          path : /root/repo/build/test

  


workflows:
  workflow:
    jobs:
      - test-examples:
          name: test-examples-2016
          image: hoodmane/spectralsequences-tl2016:1
      - test-examples:
          name: test-examples-2017
          image: hoodmane/spectralsequences-tl2017:1
      - test-examples:
          name: test-examples-2018
          image: hoodmane/spectralsequences-tl2018:1
      - test-examples:
          name: test-examples-2019
          image: hoodmane/spectralsequences-tl2019:1
      - test-examples:
          name: test-examples-2020
          image: hoodmane/spectralsequences-tl2020:1
      - test-examples:
          name: test-examples-2021
          image: hoodmane/spectralsequences-tl2021:1
      - test-examples:
          name: test-examples-latest
          image: texlive/texlive:latest


      - test-regrtest:
          name: test-regr-2016
          image: hoodmane/spectralsequences-tl2016:1
      - test-regrtest:
          name: test-regr-2017
          image: hoodmane/spectralsequences-tl2017:1
      - test-regrtest:
          name: test-regr-2018
          image: hoodmane/spectralsequences-tl2018:1
      - test-regrtest:
          name: test-regr-2019
          image: hoodmane/spectralsequences-tl2019:1
      - test-regrtest:
          name: test-regr-2020
          image: hoodmane/spectralsequences-tl2020:1
      - test-regrtest:
          name: test-regr-2021
          image: hoodmane/spectralsequences-tl2021:1
      - test-regrtest:
          name: test-regrtest-latest
          image: texlive/texlive:latest

      - build-manual:
          name: build-manual-2016
          image: hoodmane/spectralsequences-tl2016:1
      - build-manual:
          name: build-manual-2017
          image: hoodmane/spectralsequences-tl2017:1
      - build-manual:
          name: build-manual-2018
          image: hoodmane/spectralsequences-tl2018:1
      - build-manual:
          name: build-manual-2019
          image: hoodmane/spectralsequences-tl2019:1
      - build-manual:
          name: build-manual-2020
          image: hoodmane/spectralsequences-tl2020:1
      - build-manual:
          name: build-manual-2021
          image: hoodmane/spectralsequences-tl2021:1
      - build-manual:
          name: build-manual-latest
          image: texlive/texlive:latest

  texlive-latest:
    triggers:
      - schedule:
          cron: "37 15 * * 6"
          filters:
            branches:
              only:
                - master
    jobs:
      - test-examples:
          name: test-examples-latest
          image: texlive/texlive:latest
      - test-regrtest:
          name: test-regrtest-latest
          image: texlive/texlive:latest
      - build-manual:
          name: build-manual-latest
          image: texlive/texlive:latest
